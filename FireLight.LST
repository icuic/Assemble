1			   1: ;*****************************************************
2			   2: ;Company :
3			   3: ;File Name : FireLight.asm
4			   4: ;Author :
5			   5: ;Create Data : 2015-10-11
6			   6: ;Last Modified : 2015-10-11
7			   7: ;Description :
8			   8: ;Version : 1.0
9			   9: ;*****************************************************
10			   
11			   11: LIST P=69P48
12			   12: ROMSIZE=4096
13			   
14			   14: ;*****************************************************
15			   15: ;系统寄存器 ($000 ~ $02F, $380 ~ $38C)
16			   16: ;*****************************************************
17			   17: IE	EQU	00H			;中断使能/禁能控制
18			   18: IRQ	EQU	01H			;中断请求标志
19			   
20			   20: TM0	EQU	02H			;Timer0 模式寄存器
21			   21: TM1	EQU	03H			;Timer1 模式寄存器
22			   
23			   23: TL0	EQU	04H			;Timer0 重载值低4位
24			   24: TH0	EQU	05H			;Timer0 重载值高4位
25			   
26			   26: TL1	EQU	06H			;Timer1 重载值低4位
27			   27: TH1	EQU	07H			;Timer1 重载值高4位
28			   
29			   29: PORTA	EQU	08H			;PortA 数据寄存器
30			   30: PORTB	EQU	09H			;PortB 数据寄存器
31			   31: PORTC	EQU	0AH			;PortC 数据寄存器
32			   32: PORTD	EQU	0BH			;PortD 数据寄存器
33			   33: PORTE	EQU	0CH			;PortE 数据寄存器
34			   
35			   35: 					;0DH Reserved
36			   36: 				
37			   37: TBR	EQU	0EH			;查表寄存器
38			   38: INX	EQU	0FH			;间接寻址伪索引寄存器
39			   39: DPL	EQU	10H			;INX数据指针低4位
40			   40: DPM	EQU	11H			;INX数据指针中4位
41			   41: DPH	EQU	12H			;INX数据指针高4位
42			   
43			   43: TCTL1	EQU	13H			;Timer1 控制寄存器
44			   44: ADCCTL	EQU	14H			;ADC 使能与参考电压
45			   45: ADCCFG	EQU	15H			;ADC configuration
46			   46: ADCPORT	EQU	16H			;ADC PORT CONFIGURATION
47			   47: ADCCHL	EQU	17H			;ADC channel selection
48			   
49			   49: PACR	EQU	18H			;PortA 控制寄存器
50			   50: PBCR	EQU	19H			;PortB 控制寄存器
51			   51: PCCR	EQU	1AH			;PortC 控制寄存器
52			   52: PDCR	EQU	1BH			;PortD 控制寄存器
53			   53: PECR	EQU	1CH			;PortE 控制寄存器
54			   
55			   
56			   56: PPBCR 	EQU 	389H 			;PORTB 口上拉电阻控制寄存器 
57			   
58			   58: ;*****************************************************
59			   59: ;用户自定义寄存器 ($030 ~ $0EF)
60			   60: ;*****************************************************
61			   61: AC_BAK 	EQU 	30H 			;AC 值备份寄存器
62			   
63			   63: ;--------------------------------------
64			   64: ; 用于TIMER 定时
65			   65: F_TIME 		EQU 	36H 		;bit0=1, 1s 到; bit1=1, 1月到; bit2=1, 1年到。
66			   
67			   67: CNT0 		EQU 	37H 		;CNT1,CNT0组成的8BIT数据达到125时，即Timer0产生125次中断后，表示1S计时已到
68			   68: CNT1 		EQU 	38H 		;所以，CNT1=07H, CNT0=0DH
69			   
70			   70: SEC_CNT0	EQU	39H		;SEC_CNT0/1/2 以秒为单位计时
71			   71: SEC_CNT1	EQU	3AH		;当数值达到1小时，即3600(E10H)秒时，向HOUR_CNT0/1进位，自身清零。
72			   72: SEC_CNT2	EQU	3BH
73			   
74			   74: HOUR_CNT0	EQU	3CH		;HOUR_CNT0/1 以小时为单位计时
75			   75: HOUR_CNT1	EQU	3DH		;当数值达到1月时，即744(2EBH)小时时，向MONTH_CNT0/1进位，同时置F_TIME.1，自身清零。
76			   76: HOUR_CNT2	EQU	3EH		
77			   
78			   78: MONTH_CNT	EQU	3FH		;MONTH_CNT0/1 以月为单位计时
79			   79: 					;当数值达到1年时，即12(0CH)月时，，同时置F_TIME.2，自身清零。
80			   
81			   
82			   
83			   
84			   
85			   
86			   86: ;*****************************************************
87			   87: ;程序
88			   88: ;*****************************************************
89			   89: 	ORG	0000H
90			   
91			   91: 	;中断向量表
92	0x0000	0xe026	   92: 	JMP	RESET			;RESET ISP
93	0x0001	0xd400	   93: 	RTNI				;ADC INTERRUPT ISP
94	0x0002	0xe005	   94: 	JMP	TIMER0_ISP		;TIMER0 ISP
95	0x0003	0xd400	   95: 	RTNI				;TIMER1 ISP
96	0x0004	0xd400	   96: 	RTNI				;PORTB/D ISP
97			   
98			   98: ;*****************************************************
99			   99: ;Timer0 中断服务程序
100			   100: ;*****************************************************
101			   101: TIMER0_ISP:
102	0x0005	0x3c30	   102: 	STA 	AC_BAK,		00H 	;备份AC 值
103	0x0006	0x7581	   103: 	ANDIM 	IRQ,		1011B 	;清TIMER0 中断请求标志
104			   104: 	
105			   105: J1MS:
106			   106: 	;--------------------------------------------------------------------------
107	0x0007	0x58b7	   107: 	SBIM 	CNT0,		01H	;每次Timer0中断产生后，将CNT0减1
108	0x0008	0x9823	   108: 	BC 	TIMER0_ISP_END 		;CNT0仍大于0, 则结束ISP
109	0x0009	0x58b8	   109: 	SBIM	CNT1,		01H	;每次CNT0-1产生借位时，将CNT1减1
110	0x000a	0x9823	   110: 	BC	TIMER0_ISP_END
111			   111: 	
112	0x000b	0x7e37	   112: 	LDI 	CNT0,		0CH 	;重置1s 计数器
113	0x000c	0x7bb8	   113: 	LDI 	CNT1,		07H 	;重置1s 计数器
114			   114: 	
115	0x000d	0x68b6	   115: 	ORIM 	F_TIME,		0001B 	;设置 "1s 到"标志
116			   116: 	;--------------------------------------------------------------------------
117			   117: 	
118			   
119			   119: 	;--------------------------------------------------------------------------
120	0x000e	0x58b9	   120: 	SBIM	SEC_CNT0,	01H	;SEC_CNT0 每秒减1
121	0x000f	0x9823	   121: 	BC	TIMER0_ISP_END		;SEC_CNT0仍大于0，则结束ISP
122	0x0010	0x58ba	   122: 	SBIM	SEC_CNT1,	01H	;每次SEC_CNT0-1产生借位时，将SEC_CNT1减1
123	0x0011	0x9823	   123: 	BC	TIMER0_ISP_END		;SEC_CNT1仍大于0，则结束ISP
124	0x0012	0x58bb	   124: 	SBIM	SEC_CNT2,	01H	;每次SEC_CNT1-1产生借位时，将SEC_CNT2减1
125	0x0013	0x9823	   125: 	BC	TIMER0_ISP_END		;SEC_CNT2减1产生借位时，则表示1小时计时已到
126			   126: 	
127	0x0014	0x7fb9	   127: 	LDI 	SEC_CNT0,	0FH 	;重置SEC_CNT0/1/2 为E10H-1(3600-1)
128	0x0015	0x783a	   128: 	LDI 	SEC_CNT1,	00H
129	0x0016	0x7f3b	   129: 	LDI 	SEC_CNT2,	0EH
130			   130: 	;--------------------------------------------------------------------------
131			   131: 	
132			   132: 	
133			   133: 	;--------------------------------------------------------------------------
134	0x0017	0x58bc	   134: 	SBIM 	HOUR_CNT0,	01H	;HOUR_CNT0 每小时减1
135	0x0018	0x9823	   135: 	BC 	TIMER0_ISP_END 		;HOUR_CNT0 仍大于0, 则结束ISP
136	0x0019	0x58bd	   136: 	SBIM	HOUR_CNT1,	01H	;每次 HOUR_CNT0 产生借位时，将 HOUR_CNT1 减1
137	0x001a	0x9823	   137: 	BC	TIMER0_ISP_END		;HOUR_CNT1 减1产生借位时，则表示1月计时已到
138			   138: 	
139	0x001b	0x7bbc	   139: 	LDI 	HOUR_CNT0,	07H 	;重置HOUR_CNT0/1/2 为2E8H-1(744-1)
140	0x001c	0x7f3d	   140: 	LDI 	HOUR_CNT1,	0EH
141	0x001d	0x793e	   141: 	LDI	HOUR_CNT2,	02H
142			   142: 	
143	0x001e	0x6936	   143: 	ORIM 	F_TIME,		0010B 	;设置 "1月到" 标志
144			   144: 	;--------------------------------------------------------------------------
145			   145: 	
146			   146: 	
147			   147: 	;--------------------------------------------------------------------------
148	0x001f	0x58bf	   148: 	SBIM 	MONTH_CNT,	01H	;MONTH_CNT 每月减1
149	0x0020	0x9823	   149: 	BC 	TIMER0_ISP_END		;MONTH_CNT 减1产生借位时，则表示1年计时已到
150			   150: 	
151	0x0021	0x7dbf	   151: 	LDI 	MONTH_CNT,	0BH 	;重置MONTH_CNT 为0CH-1(12-1)
152			   152: 	
153	0x0022	0x6a36	   153: 	ORIM 	F_TIME,		0100B 	;设置 "1年到" 标志
154			   154: 	;--------------------------------------------------------------------------
155			   
156			   156: TIMER0_ISP_END:
157	0x0023	0x7a00	   157: 	LDI 	IE,		0100B 	;打开TIMER0 中断
158	0x0024	0x3830	   158: 	LDA 	AC_BAK,		00H 	;取出AC 值
159	0x0025	0xd400	   159: 	RTNI	
160			   160: 	
161			   161: ;*****************************************************
162			   162: ; 主程序
163			   163: ;*****************************************************
164			   164: RESET:
165	0x0026	0xffff	   165: 	NOP	
166			   166: 	
167			   
168			   168: 	
169			   169: 	
170	0x0027	0xffff	   170:  	NOP
171	0x0028	0xffff	   171: 	NOP
172			   172: ;------------------------------------------------
173			   173: ;清用户寄存器($030 ~ $0EF)
174			   174: ;-------------------------------------------------
175			   175: POWER_RESET:
176	0x0029	0x7810	   176: 	LDI 	DPL,		00H
177	0x002a	0x7991	   177: 	LDI 	DPM,		03H
178	0x002b	0x7812	   178: 	LDI 	DPH,		00H	;从$30 开始
179			   179: 	
180			   180: POWER_RESET_1:
181	0x002c	0x780f	   181: 	LDI 	INX,		00H	;向DPH,DPM,DPL组成的地址处写0
182	0x002d	0x4890	   182: 	ADIM 	DPL,		01H
183	0x002e	0x780e	   183: 	LDI 	TBR,		00H
184	0x002f	0x0411	   184: 	ADCM 	DPM,		00H
185	0x0030	0xb832	   185: 	BA3 	POWER_RESET_2
186	0x0031	0xe033	   186: 	JMP 	POWER_RESET_3
187			   
188			   188: POWER_RESET_2:
189	0x0032	0x4892	   189: 	ADIM 	DPH,		01H
190			   190: 	
191			   191: POWER_RESET_3:
192	0x0033	0x5092	   192: 	SBI 	DPH,		01H	;到$EF 结束，即在地址001 111 000B时停止
193	0x0034	0x802c	   193: 	BNZ 	POWER_RESET_1
194	0x0035	0x5391	   194: 	SBI 	DPM,		07H
195	0x0036	0x802c	   195: 	BNZ 	POWER_RESET_1
196			   
197			   197: ;----------------------------------------------
198			   198: ;初始化系统寄存器
199			   199: ;-----------------------------------------------
200			   200: SYSTEM_INITIAL:
201			   201: 	;TIMER0 初始化
202			   202: 	;
203			   203: 	;  fosc=4M, fsys=4M/4=1M
204			   204: 	;
205			   205: 	;  fsys=1M                 31250Hz                   125Hz
206			   206: 	;           -------------            -------------
207			   207: 	;  -------->| Prescaler |----------->|  Counter  |----------->
208			   208: 	;           -------------            -------------
209			   209: 	;               (32)                     (250)
210			   210: 	
211	0x0037	0x7982	   211: 	LDI 	TM0,		03H 	;设置TIMER0 预分频为/32
212	0x0038	0x7b04	   212: 	LDI 	TL0,		06H
213	0x0039	0x7805	   213: 	LDI 	TH0,		00H 	;设置中断时间为8ms
214	0x003a	0x7eb7	   214: 	LDI 	CNT0,		0DH 	;定时1s
215	0x003b	0x7bb8	   215: 	LDI 	CNT1,		07H 	;定时1s
216			   216: 	
217	0x003c	0x7fb9	   217: 	LDI	SEC_CNT0,	0FH	;SEC_CNT0/1/2 初始化为E10H - 1，即3600 -1
218	0x003d	0x783a	   218: 	LDI	SEC_CNT1,	00H
219	0x003e	0x7f3b	   219: 	LDI	SEC_CNT2,	0EH
220			   
221	0x003f	0x7bbc	   221: 	LDI	HOUR_CNT0,	07H	;HOUR_CNT0/1/2 初始化为2E8H - 1，即744 - 1
222	0x0040	0x7f3d	   222: 	LDI	HOUR_CNT1,	0EH
223	0x0041	0x793e	   223: 	LDI	HOUR_CNT2,	02H
224			   
225	0x0042	0x7dbf	   225: 	LDI	MONTH_CNT,	0BH	;MONTH_CNT 初始化为12 -1 个月
226			   226: 		
227			   
228			   228: 	;I/O 口初始化
229	0x0043	0x7809	   229: 	LDI 	PORTB,		00H
230	0x0044	0x7f99	   230: 	LDI 	PBCR,		0FH 	;设置PortB 作为输出口
231	0x0045	0x7f8c	   231: 	LDI 	PORTE,		0FH
232	0x0046	0x7f9c	   232: 	LDI 	PECR,		0FH 	;设置PortE 作为输出口
233			   
234			   234: ;--------------------------------------
235			   235: MAIN_PRE:
236	0x0047	0x7801	   236: 	LDI 	IRQ,		00H
237	0x0048	0x7a00	   237: 	LDI 	IE,		0100B 	;打开Timer0 中断
238			   
239			   239: MAIN:
240	0x0049	0x40b6	   240: 	ADI 	F_TIME,		0001B
241	0x004a	0xa04d	   241: 	BA0 	HALTMODE 		;未到1s,跳转
242	0x004b	0x7736	   242: 	ANDIM 	F_TIME,		1110B 	;清 "1s 到"标志
243	0x004c	0x6089	   243: 	EORIM	PORTB,		0001B	;翻转PB.0	
244			   244: 	
245			   245: HALTMODE:
246	0x004d	0xffff	   246: 	NOP
247	0x004e	0xd800	   247: 	HALT
248	0x004f	0xffff	   248: 	NOP
249	0x0050	0xffff	   249: 	NOP
250	0x0051	0xffff	   250: 	NOP
251	0x0052	0xe049	   251: 	JMP 	MAIN
252			   
253	0x0053	0xffff	   253: 	NOP
254	0x0054	0xffff	   254: 	NOP
255			   
256			   
257			   
258			   258: 	END
